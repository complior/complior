import type { ExternalCheck, PageData } from './types.js';

const AI_DISCLOSURE_PATTERNS = [
  /ai[- ]?powered/i,
  /ai[- ]?generated/i,
  /artificial intelligence/i,
  /powered by ai/i,
  /generated by ai/i,
  /ai assistant/i,
  /machine learning/i,
  /language model/i,
  /chatbot/i,
  /ai[- ]?enabled/i,
];

export const checkAiDisclosure = (page: PageData): ExternalCheck => {
  const html = page.html.toLowerCase();
  const matched = AI_DISCLOSURE_PATTERNS.find((p) => p.test(html));

  if (matched) {
    const match = html.match(matched);
    return {
      name: 'AI Disclosure Text',
      status: 'PASS',
      obligation: 'OBL-015',
      article: 'Art. 50(1)',
      evidence: `AI disclosure found: "${match?.[0] ?? 'detected'}"`,
      confidence: 85,
    };
  }

  return {
    name: 'AI Disclosure Text',
    status: 'FAIL',
    obligation: 'OBL-015',
    article: 'Art. 50(1)',
    evidence: 'No AI disclosure text found on page',
    confidence: 80,
  };
};

export const checkWellKnown = (page: PageData): ExternalCheck => {
  if (page.wellKnownAiCompliance) {
    try {
      const data = JSON.parse(page.wellKnownAiCompliance);
      const hasRequired = data.aiProvider || data.aiSystem || data.complianceStatus;
      return {
        name: '.well-known/ai-compliance.json',
        status: hasRequired ? 'PASS' : 'PARTIAL',
        obligation: 'OBL-021',
        article: 'Art. 50',
        evidence: hasRequired
          ? 'Compliance metadata present with required fields'
          : 'Compliance metadata found but missing required fields',
        confidence: hasRequired ? 95 : 60,
      };
    } catch {
      return {
        name: '.well-known/ai-compliance.json',
        status: 'PARTIAL',
        obligation: 'OBL-021',
        article: 'Art. 50',
        evidence: 'File exists but contains invalid JSON',
        confidence: 40,
      };
    }
  }

  return {
    name: '.well-known/ai-compliance.json',
    status: 'FAIL',
    obligation: 'OBL-021',
    article: 'Art. 50',
    evidence: 'No .well-known/ai-compliance.json found (404)',
    confidence: 90,
  };
};

export const checkMetaTags = (page: PageData): ExternalCheck => {
  const aiMeta = page.metaTags.filter((t) =>
    t.name.toLowerCase().includes('ai-') ||
    t.name.toLowerCase().includes('ai_') ||
    t.name.toLowerCase() === 'generator',
  );

  if (aiMeta.length > 0) {
    const names = aiMeta.map((t) => t.name).join(', ');
    return {
      name: 'Meta Tags',
      status: 'PASS',
      obligation: 'OBL-015',
      article: 'Art. 50(1)',
      evidence: `AI-related meta tags found: ${names}`,
      confidence: 90,
    };
  }

  return {
    name: 'Meta Tags',
    status: 'FAIL',
    obligation: 'OBL-015',
    article: 'Art. 50(1)',
    evidence: 'No AI-related meta tags found',
    confidence: 75,
  };
};

const PRIVACY_AI_PATTERNS = [
  /artificial intelligence/i,
  /machine learning/i,
  /automated decision/i,
  /ai[- ]processing/i,
  /algorithmic/i,
  /ai[- ]system/i,
  /language model/i,
];

export const checkPrivacyPolicy = (page: PageData): ExternalCheck => {
  if (!page.privacyPolicyUrl) {
    return {
      name: 'Privacy Policy AI Section',
      status: 'FAIL',
      obligation: 'GDPR + AI Act',
      article: 'Art. 50',
      evidence: 'No privacy policy link found on page',
      confidence: 70,
    };
  }

  if (!page.privacyPolicyText) {
    return {
      name: 'Privacy Policy AI Section',
      status: 'PARTIAL',
      obligation: 'GDPR + AI Act',
      article: 'Art. 50',
      evidence: `Privacy policy found at ${page.privacyPolicyUrl} but content not accessible`,
      confidence: 40,
    };
  }

  const hasAiSection = PRIVACY_AI_PATTERNS.some((p) => p.test(page.privacyPolicyText!));

  return {
    name: 'Privacy Policy AI Section',
    status: hasAiSection ? 'PASS' : 'FAIL',
    obligation: 'GDPR + AI Act',
    article: 'Art. 50',
    evidence: hasAiSection
      ? 'AI-specific section found in privacy policy'
      : 'No AI-specific section in privacy policy',
    confidence: hasAiSection ? 85 : 75,
  };
};

export const checkApiHeaders = (page: PageData): ExternalCheck => {
  const aiHeaders = Object.entries(page.headers).filter(([key]) => {
    const lower = key.toLowerCase();
    return lower.includes('x-ai-') || lower.includes('x-content-marking') || lower.includes('x-generated-by');
  });

  if (aiHeaders.length > 0) {
    const names = aiHeaders.map(([k]) => k).join(', ');
    return {
      name: 'API Response Headers',
      status: 'PASS',
      obligation: 'OBL-021',
      article: 'Art. 50',
      evidence: `AI compliance headers found: ${names}`,
      confidence: 95,
    };
  }

  return {
    name: 'API Response Headers',
    status: 'FAIL',
    obligation: 'OBL-021',
    article: 'Art. 50',
    evidence: 'No AI compliance headers (X-AI-Disclosure, X-Content-Marking) found',
    confidence: 80,
  };
};

export const checkChatbotDetection = (page: PageData): ExternalCheck => {
  let confidence = 0;
  const evidence: string[] = [];

  if (page.hasWebSocket) {
    confidence += 30;
    evidence.push('WebSocket detected (likely real-time chat)');
  }

  if (page.chatInputs.length > 0) {
    confidence += 40;
    const placeholders = page.chatInputs.map((i) => i.placeholder).filter(Boolean);
    evidence.push(`Chat input found${placeholders.length ? `: "${placeholders[0]}"` : ''}`);
  }

  const chatPatterns = /chat|message|ask|conversation|assistant/i;
  if (chatPatterns.test(page.html)) {
    confidence += 20;
    evidence.push('Chat-related keywords found in DOM');
  }

  if (confidence >= 50) {
    return {
      name: 'Chatbot Detection',
      status: 'PASS',
      obligation: 'Detection',
      article: 'Art. 50',
      evidence: `AI chatbot detected (confidence ${confidence}%): ${evidence.join('; ')}`,
      confidence,
    };
  }

  if (confidence > 0) {
    return {
      name: 'Chatbot Detection',
      status: 'PARTIAL',
      obligation: 'Detection',
      article: 'Art. 50',
      evidence: `Possible AI interface (confidence ${confidence}%): ${evidence.join('; ')}`,
      confidence,
    };
  }

  return {
    name: 'Chatbot Detection',
    status: 'N_A',
    obligation: 'Detection',
    article: 'Art. 50',
    evidence: 'No AI chatbot interface detected',
    confidence: 60,
  };
};

export const checkImageMetadata = (page: PageData): ExternalCheck => {
  if (page.images.length === 0) {
    return {
      name: 'Image Metadata (C2PA/IPTC)',
      status: 'N_A',
      obligation: 'OBL-016',
      article: 'Art. 50(2)',
      evidence: 'No images found on page',
      confidence: 100,
    };
  }

  // In a real implementation, we'd download images and check C2PA.
  // For L1 passive crawl, we check for alt-text AI indicators.
  const aiImages = page.images.filter((img) =>
    /ai[- ]generated|generated by|dall-?e|midjourney|stable diffusion/i.test(img.alt || img.src),
  );

  if (aiImages.length === 0) {
    return {
      name: 'Image Metadata (C2PA/IPTC)',
      status: 'PARTIAL',
      obligation: 'OBL-016',
      article: 'Art. 50(2)',
      evidence: `${page.images.length} images found, none indicate AI generation in metadata/alt`,
      confidence: 50,
    };
  }

  return {
    name: 'Image Metadata (C2PA/IPTC)',
    status: 'FAIL',
    obligation: 'OBL-016',
    article: 'Art. 50(2)',
    evidence: `${aiImages.length} AI-generated images detected without C2PA provenance`,
    confidence: 70,
  };
};

const HUMAN_ESCALATION_PATTERNS = [
  /talk to (?:a )?human/i,
  /contact support/i,
  /speak (?:to|with) (?:a )?(?:person|agent|representative)/i,
  /human (?:agent|support|assistance)/i,
  /live (?:chat|agent|support)/i,
  /request (?:a )?callback/i,
  /escalat/i,
];

export const checkHumanEscalation = (page: PageData): ExternalCheck => {
  const htmlAndLinks = page.html + ' ' + page.links.map((l) => l.text).join(' ');
  const matched = HUMAN_ESCALATION_PATTERNS.find((p) => p.test(htmlAndLinks));

  if (matched) {
    const match = htmlAndLinks.match(matched);
    return {
      name: 'Human Escalation',
      status: 'PASS',
      obligation: 'OBL-008',
      article: 'Art. 14',
      evidence: `Human escalation option found: "${match?.[0] ?? 'detected'}"`,
      confidence: 85,
    };
  }

  return {
    name: 'Human Escalation',
    status: 'FAIL',
    obligation: 'OBL-008',
    article: 'Art. 14',
    evidence: 'No human escalation option (talk to human, contact support) found',
    confidence: 70,
  };
};

export const ALL_L1_CHECKS = [
  checkAiDisclosure,
  checkWellKnown,
  checkMetaTags,
  checkPrivacyPolicy,
  checkApiHeaders,
  checkChatbotDetection,
  checkImageMetadata,
  checkHumanEscalation,
] as const;
